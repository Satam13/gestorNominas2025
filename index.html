<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Extractor de cuadrante + horas extras detalladas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <style>
    .cell-break { white-space: pre-wrap; word-break: break-word; }
    .small { font-size: 0.9rem; color: #4b5563; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen flex items-start justify-center p-6">
  <div class="w-full max-w-7xl bg-white shadow-md rounded-lg p-6">
    <h1 class="text-2xl font-semibold mb-4">Extractor de cuadrante + horas extras detalladas</h1>

    <div class="mb-3 flex items-center gap-3">
      <label class="w-full">
        <span class="block text-sm text-gray-600 mb-1">Selecciona el archivo PDF:</span>
        <input id="fileInput" type="file" accept="application/pdf" class="block w-full" />
      </label>
      <div id="fileName" class="text-sm text-gray-500"></div>
    </div>

    <div class="mb-2 flex items-center gap-4">
      <div id="status" class="text-sm text-gray-700">Esperando PDF...</div>
      <div id="verification" class="text-sm"></div>
    </div>

    <div class="mb-4">
      <label class="block text-sm font-medium mb-1">Festivos (editable, formato DD-MM; separados por comas)</label>
      <textarea id="holidaysInput" class="border p-2 rounded w-full font-mono text-sm" rows="2"></textarea>
      <div class="text-xs text-gray-500 mt-1">Ejemplo: 01-01,06-01,01-05,15-08,12-10,01-11,06-12,08-12,25-12</div>
      <div class="mt-2 flex gap-2">
        <button id="saveHolidays" class="px-3 py-1 bg-blue-600 text-white rounded">Guardar festivos</button>
        <button id="resetHolidays" class="px-3 py-1 border rounded">Restablecer por defecto</button>
      </div>
    </div>

    <div id="extras" class="mb-2 text-sm font-medium"></div>

    <div id="tableContainer" class="overflow-x-auto"></div>

    <template id="tableTemplate">
      <table class="min-w-full border-collapse">
        <thead>
          <tr class="bg-gray-100">
            <th class="px-3 py-2 text-left">Día</th>
            <th class="px-3 py-2 text-left">Horario</th>
            <th class="px-3 py-2 text-left">Servicio - Producto</th>
            <th class="px-3 py-2 text-right">H. DIA</th>
            <th class="px-3 py-2 text-right">Festivo (h)</th>
            <th class="px-3 py-2 text-right">Nocturna (h)</th>
            <th class="px-3 py-2 text-right">Ra. Básica (h)</th>
            <th class="px-3 py-2 text-right">Extras Festivo</th>
            <th class="px-3 py-2 text-right">Extras Nocturna</th>
            <th class="px-3 py-2 text-right">Extras Ra. Básica</th>
            <th class="px-3 py-2 text-right">Vigilante con arma (h teóricas)</th>
            <th class="px-3 py-2 text-right">Vigilante con arma (h extras)</th>
            <th class="px-3 py-2 text-right">H. Extras</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
        <tfoot>
          <tr class="bg-gray-50">
            <td colspan="3" class="px-3 py-2 font-semibold text-right">Totales:</td>
            <td id="totalHoras" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalFestivo" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalNocturno" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalRadioscopia" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalExtrasFestivo" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalExtrasNocturno" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalExtrasRadioscopia" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalVigilanteTeoricas" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalVigilanteExtras" class="px-3 py-2 font-semibold text-right">0,00</td>
            <td id="totalHorasExtras" class="px-3 py-2 font-semibold text-right">0,00</td>
          </tr>
        </tfoot>
      </table>
    </template>
  </div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

const fileInput = document.getElementById('fileInput');
const status = document.getElementById('status');
const tableContainer = document.getElementById('tableContainer');
const fileNameEl = document.getElementById('fileName');
const extrasEl = document.getElementById('extras');
const holidaysInput = document.getElementById('holidaysInput');
const saveHolidaysBtn = document.getElementById('saveHolidays');
const resetHolidaysBtn = document.getElementById('resetHolidays');

const defaultHolidays = ['01-01','06-01','01-05','15-08','12-10','01-11','06-12','08-12','25-12'];
let holidayList = [...defaultHolidays];
holidaysInput.value = holidayList.join(',');

saveHolidaysBtn.addEventListener('click', () => {
  holidayList = holidaysInput.value.split(',').map(s => s.trim()).filter(Boolean);
  status.textContent = 'Festivos actualizados.';
});
resetHolidaysBtn.addEventListener('click', () => {
  holidayList = [...defaultHolidays];
  holidaysInput.value = holidayList.join(',');
  status.textContent = 'Festivos restablecidos.';
});

const monthNames = {
  'enero':0,'febrero':1,'marzo':2,'abril':3,'mayo':4,'junio':5,
  'julio':6,'agosto':7,'septiembre':8,'setiembre':8,'octubre':9,'noviembre':10,'diciembre':11
};

function isLeapYear(y){ return (y%4===0 && y%100!==0) || (y%400===0); }

function parseHorario(day, monthIndex, year, horario){
  if(!horario || horario.toUpperCase()==='LIBRE') return null;
  const m = horario.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
  if(!m) return null;
  const [_, sh, sm, eh, em] = m.map(Number);
  const start = new Date(year, monthIndex, day, sh, sm, 0);
  let end = new Date(year, monthIndex, day, eh, em, 0);
  if(end <= start) end.setDate(end.getDate()+1);
  return {start, end};
}

function overlap(aStart, aEnd, bStart, bEnd){
  const s = aStart > bStart ? aStart : bStart;
  const e = aEnd < bEnd ? aEnd : bEnd;
  const diff = (e - s) / 3600000;
  return diff > 0 ? diff : 0;
}

function format(n){ return n.toFixed(2).replace('.', ','); }

function limpiarServicio(text) {
  if (!text) return '—';
  const stopWords = /(SILC|CAIXABANK|CPD|Camí|Parc|Cerdanyola|VALLES|INMOBLES)/i;
  const m = text.match(stopWords);
  if (m) text = text.substring(0, m.index).trim();
  text = text.replace(/^SERVICIO\s*/i, '').trim();
  return text || '—';
}

function generateFestiveIntervals(month, year, rows){
  const intervals = [];
  for(const e of holidayList){
    const [d,m] = e.split('-').map(Number);
    if(!d||!m) continue;
    const start = new Date(year, m-1, d, 0,0,0);
    const end = new Date(year, m-1, d+1, 0,0,0);
    intervals.push({start, end});
  }
  return intervals;
}

fileInput.addEventListener('change', async ev=>{
  const file = ev.target.files[0];
  if(!file) return;
  fileNameEl.textContent = file.name;
  status.textContent = 'Leyendo PDF...';
  extrasEl.textContent = '';

  try{
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    let lines=[];
    for(let p=1;p<=pdf.numPages;p++){
      const page = await pdf.getPage(p);
      const text = await page.getTextContent();
      const items = text.items.map(it=>({t:it.str,x:it.transform[4],y:it.transform[5]}));
      items.sort((a,b)=>(b.y-a.y)||(a.x-b.x));
      let currentY=null,row=[];
      for(const it of items){
        if(currentY===null) currentY=it.y;
        if(Math.abs(it.y-currentY)<5){ row.push(it); }
        else{
          lines.push(row.map(r=>r.t).join(' ').trim());
          currentY=it.y; row=[it];
        }
      }
      if(row.length) lines.push(row.map(r=>r.t).join(' ').trim());
    }

    let month=null, year=null;
    for(const l of lines){
      const lower = l.toLowerCase();
      for(const m in monthNames){ if(lower.includes(m)) month = monthNames[m]; }
      const y = l.match(/(20\d{2})/); if(y) year=parseInt(y[1]);
    }
    if(month===null) month = new Date().getMonth();
    if(!year) year = new Date().getFullYear();

    const stop=lines.findIndex(l=>/TOTAL\s+HORAS|Próxima fecha/i.test(l));
    if(stop!==-1) lines=lines.slice(0,stop);

    const rows=[], reDia=/^\*?\s*(\d{1,2})\b/, reHor=/^(LIBRE|\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2})/i, reNum=/(\d{1,3}[.,]\d{2})/g;
    for(const l of lines){
      const m=l.match(reDia); if(!m) continue;
      const dia=parseInt(m[1]); let rest=l.slice(m[0].length).trim();
      const h=rest.match(reHor); let horario=h?h[1].toUpperCase():'',horas='0,00';
      if(h) rest=rest.slice(h[0].length).trim();
      const nums=[...rest.matchAll(reNum)]; if(nums.length){ horas=nums.at(-1)[1]; rest=rest.slice(0,nums.at(-1).index).trim(); }
      let servicio=limpiarServicio(rest);
      rows.push({dia,horario,servicio,horas});
    }

    if(rows.length===0){status.textContent='No se detectaron filas válidas.';return;}

    tableContainer.innerHTML='';
    const tmpl=document.getElementById('tableTemplate');
    const clone=tmpl.content.cloneNode(true);
    const tbody=clone.getElementById('tableBody');

    const festivos=generateFestiveIntervals(month,year,rows);
    const diasMes=Math.max(...rows.map(r=>r.dia));
    const coef=1782/(isLeapYear(year)?335:334);
    const horasTeoricasMes=coef*diasMes;

    let acumHoras=0;
    let totH=0, totF=0, totN=0, totR=0, totFExtra=0, totNExtra=0, totRExtra=0;
    let totVigilanteTeoricas=0, totVigilanteExtras=0, totHorasExtras=0;

    for(const r of rows){
      let hNum=parseFloat(r.horas.replace(',','.'))||0;
      let hNormal=0, hExtra=0;
      if(acumHoras < horasTeoricasMes){
        if(acumHoras + hNum <= horasTeoricasMes){
          hNormal = hNum;
          hExtra = 0;
        } else {
          hNormal = horasTeoricasMes - acumHoras;
          hExtra = hNum - hNormal;
        }
      } else {
        hNormal = 0;
        hExtra = hNum;
      }
      acumHoras += hNormal;

      let fest=0, noct=0, ra=0, festExtra=0, noctExtra=0, raExtra=0;
      let vigTeor=0, vigExtra=0;
      const rng=parseHorario(r.dia,month,year,r.horario);
      if(rng){
        for(const f of festivos){
          const ov = overlap(rng.start,rng.end,f.start,f.end);
          if(acumHoras - hNormal < horasTeoricasMes){
            const teor = Math.min(ov, hNormal - fest);
            fest += teor;
            const extra = ov - teor;
            if(extra>0) festExtra += extra;
          } else {
            festExtra += ov;
          }
        }
        const nStart=new Date(rng.start.getFullYear(),rng.start.getMonth(),rng.start.getDate(),22,0,0);
        const nEnd=new Date(nStart.getTime()+8*3600000);
        const ovN = overlap(rng.start,rng.end,nStart,nEnd);
        if(acumHoras - hNormal < horasTeoricasMes){
          const teor = Math.min(ovN, hNormal - noct);
          noct += teor;
          const extra = ovN - teor;
          if(extra>0) noctExtra += extra;
        } else {
          noctExtra += ovN;
        }
      }

      if(r.servicio.toLowerCase().includes('radioscopia básica')){
        ra = hNormal;
        raExtra = hExtra;
      }

      if(r.servicio.toLowerCase().includes('vigilante con arma')){
        vigTeor = hNormal;
        vigExtra = hExtra;
      }

      const diaHExtra = hExtra; // todas las horas extras
      totHorasExtras += diaHExtra;
      totH += hNormal;
      totF += fest;
      totN += noct;
      totR += ra;
      totFExtra += festExtra;
      totNExtra += noctExtra;
      totRExtra += raExtra;
      totVigilanteTeoricas += vigTeor;
      totVigilanteExtras += vigExtra;

      const tr=document.createElement('tr');
      tr.className='border-b';
      tr.innerHTML=`
        <td class="px-3 py-2">${r.dia}</td>
        <td class="px-3 py-2">${r.horario}</td>
        <td class="px-3 py-2 cell-break">${r.servicio}</td>
        <td class="px-3 py-2 text-right">${format(hNormal)}</td>
        <td class="px-3 py-2 text-right">${format(fest)}</td>
        <td class="px-3 py-2 text-right">${format(noct)}</td>
        <td class="px-3 py-2 text-right">${format(ra)}</td>
        <td class="px-3 py-2 text-right">${format(festExtra)}</td>
        <td class="px-3 py-2 text-right">${format(noctExtra)}</td>
        <td class="px-3 py-2 text-right">${format(raExtra)}</td>
        <td class="px-3 py-2 text-right">${format(vigTeor)}</td>
        <td class="px-3 py-2 text-right">${format(vigExtra)}</td>
        <td class="px-3 py-2 text-right">${format(diaHExtra)}</td>`;
      tbody.appendChild(tr);
    }

    tableContainer.appendChild(clone);
    document.getElementById('totalHoras').textContent=format(totH);
    document.getElementById('totalFestivo').textContent=format(totF);
    document.getElementById('totalNocturno').textContent=format(totN);
    document.getElementById('totalRadioscopia').textContent=format(totR);
    document.getElementById('totalExtrasFestivo').textContent=format(totFExtra);
    document.getElementById('totalExtrasNocturno').textContent=format(totNExtra);
    document.getElementById('totalExtrasRadioscopia').textContent=format(totRExtra);
    document.getElementById('totalVigilanteTeoricas').textContent=format(totVigilanteTeoricas);
    document.getElementById('totalVigilanteExtras').textContent=format(totVigilanteExtras);
    document.getElementById('totalHorasExtras').textContent=format(totHorasExtras);

    status.textContent='Procesado correctamente.';
  } catch(e){
    console.error(e);
    status.textContent='Error al procesar PDF.';
  }
});
</script>
</body>
</html>
